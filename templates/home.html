{% extends 'base.html' %}
{% block content %}
<div class="text-center mb-4">
  <h1 class="display-6">Welcome to JBucks</h1>
  <p class="text-muted">Track expenses for You or Paid for Others</p>
</div>

<div class="row g-3">
  <div class="col-12 col-md-6">
    <div class="option-tile" onclick="location.href='{{ url_for('add_expense') }}?category=&paid_for_other=0'">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h3 class="mb-1">You</h3>
          <p class="text-muted mb-2">Add your own expenses</p>
          <div class="row g-2 mt-2">
            {% for c in ['Food','Traveling','Entertainment','Other'] %}
            <div class="col-6 col-sm-3 mb-2">
              <div class="category-box" onclick="event.stopPropagation(); location.href='{{ url_for('add_expense') }}?category={{c}}&paid_for_other=0'">
                <i class="bi bi-tag-fill me-1"></i> {{ c }}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="text-muted">
          <i class="bi bi-person-circle" style="font-size:34px"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-6">
    <div class="option-tile" data-bs-toggle="modal" data-bs-target="#paidForModal" style="cursor:pointer;">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h3 class="mb-1">Paid for Others</h3>
          <p class="text-muted mb-2">Record payments you made for someone else</p>
          <small class="text-muted">Tap to choose or add a person</small>
        </div>
        <div class="text-muted">
          <i class="bi bi-people-fill" style="font-size:34px"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- simple monthly summaries -->
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card p-3">
      <h6>This month — You</h6>
      <h4>₹{{ '%.2f'|format(you_total) }}</h4>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3">
      <h6>This month — Paid for Others</h6>
      <h4>₹{{ '%.2f'|format(others_total) }}</h4>
    </div>
  </div>
</div>

<!-- Paid for Others Modal (two-step via simple JS) -->
<div class="modal fade" id="paidForModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" method="post" action="{{ url_for('add_expense') }}" id="paidForForm" onsubmit="return finalizeSubmit(event);">
      <div class="modal-header">
        <h5 class="modal-title">Paid for whom?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="step1">
          <div class="mb-3">
            <label class="form-label">Select existing name</label>
            <select class="form-select" id="existingPayee">
              <option value="">-- choose --</option>
              {% for p in payees %}
              <option value="{{ p.name }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Or enter new name</label>
            <input type="text" class="form-control" id="newPayee" placeholder="Type name">
          </div>
          <div class="form-text">Choose or enter name, then press Next.</div>
        </div>

        <div id="step2" style="display:none">
          <div class="mb-3">
            <label class="form-label">Amount <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="modalAmount" required>
          </div>
          <div class="mb-3">
            <label class="form-label">For what (optional)</label>
            <input type="text" class="form-control" id="modalDescription">
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" id="modalCategory">
              <option>Food</option>
              <option>Traveling</option>
              <option>Entertainment</option>
              <option>Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" id="modalDate" value="{{ today }}">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="backBtn" style="display:none" onclick="showStep(1)">Back</button>
        <button type="button" class="btn btn-primary" id="nextBtn" onclick="onNext()">Next</button>
        <button type="submit" class="btn btn-success" id="saveBtn" style="display:none">Save Entry</button>
        <button type="button" class="btn btn-link" data-bs-dismiss="modal">Cancel</button>

        <input type="hidden" name="paid_for_other" value="1">
      </div>
    </form>
  </div>
</div>

<script>
  function showStep(s){
    document.getElementById('step1').style.display = s===1 ? '' : 'none';
    document.getElementById('step2').style.display = s===2 ? '' : 'none';
    document.getElementById('nextBtn').style.display = s===1 ? '' : 'none';
    document.getElementById('saveBtn').style.display = s===2 ? '' : 'none';
    document.getElementById('backBtn').style.display = s===2 ? '' : 'none';
    document.querySelector('#paidForModal .modal-title').textContent = s===1 ? 'Paid for whom?' : 'Amount & details';
  }

  function onNext(){
    const existing = document.getElementById('existingPayee').value.trim();
    const newName = document.getElementById('newPayee').value.trim();
    const finalName = newName || existing;
    if(!finalName){
      alert('Please select or enter a name.');
      return;
    }
    const form = document.getElementById('paidForForm');
    let prev = form.querySelector('input[name="payee_name"]');
    if(prev) prev.remove();
    const inp = document.createElement('input');
    inp.type = 'hidden';
    inp.name = 'payee_name';
    inp.value = finalName;
    form.appendChild(inp);
    showStep(2);
  }

  function finalizeSubmit(e){
    const amt = document.getElementById('modalAmount').value;
    if(!amt || parseFloat(amt) <= 0){
      alert('Enter a valid amount > 0.');
      return false;
    }
    const form = document.getElementById('paidForForm');
    ['amount','description','category','date'].forEach(n=>{
      const p = form.querySelector('input[name="'+n+'"], select[name="'+n+'"]');
      if(p) p.remove();
    });
    const a = document.createElement('input'); a.type='hidden'; a.name='amount'; a.value = amt; form.appendChild(a);
    const d = document.createElement('input'); d.type='hidden'; d.name='description'; d.value = document.getElementById('modalDescription').value || ''; form.appendChild(d);
    const c = document.createElement('input'); c.type='hidden'; c.name='category'; c.value = document.getElementById('modalCategory').value; form.appendChild(c);
    const dt = document.createElement('input'); dt.type='hidden'; dt.name='date'; dt.value = document.getElementById('modalDate').value; form.appendChild(dt);
    return true;
  }
</script>
{% endblock %}
